<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>週次家計簿</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: #f5f5f5;
      padding: 32px 48px 48px 48px; /* 左右を広めに */
      max-width: 680px;
      margin: 0 auto;
    }

    h2 {
      margin: 28px 0 12px 12px; /* 左にインデント */
      font-size: 1.15rem;
    }

    .card {
      background: white;
      padding: 24px;          /* カード内も余裕を持たせる */
      border-radius: 12px;
      margin-bottom: 24px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
    }

    input {
      width: 100%;
      padding: 12px 14px;
      margin-bottom: 12px;
      border-radius: 6px;
      border: 1px solid #ddd;
      font-size: 16px;
    }

    button {
      padding: 8px 14px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }

    .btn-main {
      background: #1976d2;
      color: white;
    }

    .btn-edit {
      background: #616161;
      color: white;
      margin-right: 4px;
    }

    .btn-del {
      background: #c62828;
      color: white;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th,
    td {
      padding: 10px 8px;
      border-bottom: 1px solid #eee;
      text-align: right;
    }

    th:first-child,
    td:first-child {
      text-align: left;
    }

    .amount-negative {
      color: #b71c1c;
    }

    .amount-positive {
      color: #1b5e20;
    }

    /* トースト（ボタンの近く or 画面下中央） */
    .toast {
      position: absolute;
      background: #333;
      color: white;
      padding: 6px 10px;
      border-radius: 16px;
      font-size: 12px;
      white-space: nowrap;
      opacity: 0;
      transition: opacity 0.2s;
      pointer-events: none;
      z-index: 999;
    }

    .toast.show {
      opacity: 1;
    }

    @media (max-width: 600px) {
      body {
        padding: 24px 20px 32px 20px;
      }
      h2 {
        margin-left: 8px;
      }
    }
  </style>
</head>
<body>
  <h2>週予算</h2>
  <div class="card">
    <form id="budget-form">
      <input type="number" id="budget-input" placeholder="週予算（円）" />
      <button class="btn-main">保存</button>
    </form>
  </div>

  <h2>入力</h2>
  <div class="card">
    <form id="entry-form">
      <input type="date" id="date-input" required />
      <input type="number" id="amount-input" placeholder="金額（円）" required />
      <button class="btn-main">登録</button>
    </form>
  </div>

  <h2>週ごとの集計</h2>
  <div class="card">
    <table id="weekly-table">
      <thead>
        <tr>
          <th>週</th>
          <th>合計</th>
          <th>予算</th>
          <th>残り</th>
          <th>使用率</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <h2>直近10日</h2>
  <div class="card">
    <table id="entry-table">
      <thead>
        <tr>
          <th>日付</th>
          <th>金額</th>
          <th></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    const STORAGE_KEY = "kakeibo_entries";
    const BUDGET_KEY = "kakeibo_budget";
    let editingId = null;

    // YYYY-MM-DD → Date（ローカル正規化）
    function parseDateStrict(str) {
      const [y, m, d] = str.split("-").map(Number);
      return new Date(y, m - 1, d);
    }

    function showToast(message, button) {
      const toast = document.getElementById("toast");
      toast.textContent = message;

      // 位置計算用に一旦 (0,0) にして show
      toast.style.top = "0px";
      toast.style.left = "0px";
      toast.classList.add("show");

      const toastWidth = toast.offsetWidth;
      const toastHeight = toast.offsetHeight;

      let top =
        window.scrollY + window.innerHeight - 80 - toastHeight / 2;
      let left =
        window.scrollX + window.innerWidth / 2 - toastWidth / 2;

      if (button) {
        const rect = button.getBoundingClientRect();

        // 基本はボタン右側
        top =
          window.scrollY +
          rect.top +
          rect.height / 2 -
          toastHeight / 2;
        left = window.scrollX + rect.right + 8;

        // 右にはみ出すなら左側に回り込む
        if (left + toastWidth + 8 > window.scrollX + window.innerWidth) {
          left = window.scrollX + rect.left - toastWidth - 8;
        }
        // 上下にはみ出す場合は補正
        if (top < window.scrollY + 10) top = window.scrollY + 10;
        if (top + toastHeight > window.scrollY + window.innerHeight - 10) {
          top = window.scrollY + window.innerHeight - toastHeight - 10;
        }
      }

      toast.style.top = `${top}px`;
      toast.style.left = `${left}px`;

      setTimeout(() => toast.classList.remove("show"), 1200);
    }

    function loadEntries() {
      return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
    }
    function saveEntries(entries) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));
    }

    function loadBudget() {
      return Number(localStorage.getItem(BUDGET_KEY) || 0);
    }
    function saveBudget(budget) {
      localStorage.setItem(BUDGET_KEY, budget);
    }

    function getWeekRange(dateStr) {
      const date = parseDateStrict(dateStr);
      const day = date.getDay(); // 0=日
      const sunday = new Date(date);
      sunday.setDate(date.getDate() - day);
      const saturday = new Date(sunday);
      saturday.setDate(sunday.getDate() + 6);
      return { start: sunday, end: saturday };
    }

    function formatDate(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    function render() {
      const entries = loadEntries();
      const budget = loadBudget();
      renderEntries(entries);
      renderWeekly(entries, budget);
    }

    function renderEntries(entries) {
      const tbody = document.querySelector("#entry-table tbody");
      tbody.innerHTML = "";

      const today = new Date();
      const todayBase = new Date(
        today.getFullYear(),
        today.getMonth(),
        today.getDate()
      );

      entries.sort((a, b) => a.date.localeCompare(b.date));

      let count = 0;
      for (const e of entries) {
        const d = parseDateStrict(e.date);

        // 日数差（今日を0として、0〜9日前だけ通す）
        const diffDays = Math.floor(
          (todayBase - d) / (1000 * 60 * 60 * 24)
        );

        if (diffDays < 0 || diffDays > 9) continue;

        const tr = document.createElement("tr");
        const tdDate = document.createElement("td");
        const tdAmount = document.createElement("td");
        const tdButtons = document.createElement("td");

        tdDate.textContent = e.date;
        tdAmount.textContent = e.amount;
        tdAmount.className =
          e.amount < 0 ? "amount-negative" : "amount-positive";

        const btnEdit = document.createElement("button");
        btnEdit.textContent = "編集";
        btnEdit.className = "btn-edit";

        const btnDel = document.createElement("button");
        btnDel.textContent = "削除";
        btnDel.className = "btn-del";

        btnEdit.onclick = (ev) => {
          const dateInput = document.getElementById("date-input");
          const amountInput = document.getElementById("amount-input");
          const form = document.getElementById("entry-form");

          dateInput.value = e.date;
          amountInput.value = e.amount;
          editingId = e.id;

          // 入力フォームへスクロール＆金額欄にフォーカス
          form.scrollIntoView({ behavior: "smooth", block: "start" });
          setTimeout(() => amountInput.focus(), 300);

          showToast("編集モード", ev.target);
        };

        btnDel.onclick = () => {
          let arr = loadEntries().filter((x) => x.id !== e.id);
          saveEntries(arr);
          render();
          // 削除時のトーストは画面下中央固定（button を渡さない）
          showToast("削除しました", null);
        };

        tdButtons.appendChild(btnEdit);
        tdButtons.appendChild(btnDel);

        tr.appendChild(tdDate);
        tr.appendChild(tdAmount);
        tr.appendChild(tdButtons);
        tbody.appendChild(tr);
        count++;
      }

      if (count === 0) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 3;
        td.textContent = "直近10日間のデータがない。";
        tr.appendChild(td);
        tbody.appendChild(tr);
      }
    }

    function renderWeekly(entries, budget) {
      const map = {};

      for (const e of entries) {
        const range = getWeekRange(e.date);
        const key = formatDate(range.start);
        if (!map[key]) {
          map[key] = { start: range.start, end: range.end, total: 0 };
        }
        map[key].total += Number(e.amount);
      }

      const tbody = document.querySelector("#weekly-table tbody");
      tbody.innerHTML = "";

      const weeks = Object.values(map).sort((a, b) => b.start - a.start);

      if (weeks.length === 0) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 5;
        td.textContent = "まだデータがない。";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      for (const w of weeks) {
        const tr = document.createElement("tr");
        const remain = budget ? budget - w.total : "-";
        const rate = budget ? ((w.total / budget) * 100).toFixed(1) + "%" : "-";

        tr.innerHTML = `
          <td>${formatDate(w.start)}〜${formatDate(w.end)}</td>
          <td>${w.total}</td>
          <td>${budget || "-"}</td>
          <td>${remain}</td>
          <td>${rate}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    // 入力フォーム送信
    document
      .getElementById("entry-form")
      .addEventListener("submit", (e) => {
        e.preventDefault();
        const dateInput = document.getElementById("date-input");
        const amountInput = document.getElementById("amount-input");
        const btn = e.submitter;

        const date = dateInput.value;
        const amount = Number(amountInput.value);
        if (!date || !Number.isFinite(amount)) return;

        let entries = loadEntries();

        if (editingId) {
          entries = entries.map((x) =>
            x.id === editingId ? { ...x, date, amount } : x
          );
          editingId = null;
          showToast("更新しました", btn);
        } else {
          entries.push({ id: Date.now(), date, amount });
          showToast("登録しました", btn);
        }

        saveEntries(entries);
        render();
        e.target.reset();
      });

    // 予算フォーム送信
    document
      .getElementById("budget-form")
      .addEventListener("submit", (e) => {
        e.preventDefault();
        const budgetInput = document.getElementById("budget-input");
        const b = Number(budgetInput.value);
        const btn = e.submitter;

        if (!Number.isFinite(b) || b < 0) {
          showToast("0以上の数字を入力", btn);
          return;
        }

        saveBudget(b);
        render();
        showToast("保存しました", btn);
      });

    // 初期化
    (function init() {
      const today = new Date();
      const y = today.getFullYear();
      const m = String(today.getMonth() + 1).padStart(2, "0");
      const d = String(today.getDate()).padStart(2, "0");
      document.getElementById("date-input").value = `${y}-${m}-${d}`;

      const budget = loadBudget();
      if (budget > 0) {
        document.getElementById("budget-input").value = budget;
      }

      render();
    })();
  </script>
</body>
</html>
